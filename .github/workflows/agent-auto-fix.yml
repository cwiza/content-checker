name: Auto-fix with Coding Agent

on:
  issues:
    types: [labeled]

jobs:
  trigger-agent-fix:
    # Only run on issues with the content-validation label
    if: contains(github.event.issue.labels.*.name, 'content-validation')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.issue.body }}  # Extract branch from issue
          
      - name: Parse issue for file and errors
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body;
            
            // Extract filename from issue title: "[Content Validation] page2test.md"
            const titleMatch = issue.title.match(/\[Content Validation\]\s+(.+)/);
            const filename = titleMatch ? titleMatch[1] : null;
            
            if (!filename) {
              console.log('Could not extract filename from issue');
              return;
            }
            
            // Extract PR number from issue body
            const prMatch = body.match(/\*\*PR:\*\*\s+#(\d+)/);
            const prNumber = prMatch ? prMatch[1] : null;
            
            core.setOutput('filename', filename);
            core.setOutput('pr_number', prNumber);
            
            // Count issues by severity
            const criticalCount = (body.match(/ðŸ”´/g) || []).length;
            const highCount = (body.match(/ðŸŸ¡/g) || []).length;
            
            core.setOutput('critical_count', criticalCount);
            core.setOutput('high_count', highCount);
            core.setOutput('auto_fixable', criticalCount + highCount <= 10);  // Only auto-fix if <10 issues

      - name: Comment on issue - Agent assigned
        if: steps.parse.outputs.auto_fixable == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const filename = '${{ steps.parse.outputs.filename }}';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `ðŸ¤– **Coding Agent Assigned**\n\nI'm analyzing the issues in \`${filename}\` and will create a fix.\n\n**Status:** Working on fixes...\n**Timeline:** ~2-3 minutes\n\nOnce complete, I'll post a PR for your review. You can approve or request changes.`
            });

      - name: Trigger GitHub Copilot Workspace
        if: steps.parse.outputs.auto_fixable == 'true'
        run: |
          echo "Creating agent task for file: ${{ steps.parse.outputs.filename }}"
          gh issue comment ${{ github.event.issue.number }} --body "/fix-content ${{ steps.parse.outputs.filename }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create manual review label
        if: steps.parse.outputs.auto_fixable != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const criticalCount = '${{ steps.parse.outputs.critical_count }}';
            const highCount = '${{ steps.parse.outputs.high_count }}';
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              labels: ['needs-manual-review']
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `âš ï¸ **Too many issues for auto-fix**\n\nThis file has ${criticalCount} critical and ${highCount} high priority issues.\n\n**Action required:** Please review and fix manually, or use the /fix-content command to attempt automated fixes.`
            });
