name: Auto-fix Content Issues

on:
  issue_comment:
    types: [created]

jobs:
  auto-fix:
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/fix-content') &&
      contains(github.event.issue.labels.*.name, 'content-validation') &&
      (github.event.comment.author_association == 'OWNER' || 
       github.event.comment.author_association == 'MEMBER' ||
       github.event.comment.author_association == 'COLLABORATOR')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.issue.pull_request.head.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get filename from comment
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            // Extract filename from "/fix-content filename.md"
            const match = comment.match(/\/fix-content\s+(\S+)/);
            const filename = match ? match[1] : null;
            
            if (!filename) {
              core.setFailed('No filename found in comment. Use: /fix-content filename.md');
              return;
            }
            
            core.setOutput('filename', filename);
            core.info(`Filename: ${filename}`);

      - name: Apply auto-fixes
        env:
          FILENAME: ${{ steps.parse.outputs.filename }}
        run: |
          # Validate filename to prevent command injection
          if [[ ! "$FILENAME" =~ ^[a-zA-Z0-9._/-]+$ ]]; then
            echo "Invalid filename format"
            exit 1
          fi
          node .github/scripts/auto-fix.js "$FILENAME"

      - name: Commit fixes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add "${{ steps.parse.outputs.filename }}"
          git commit -m "Auto-fix content issues in ${{ steps.parse.outputs.filename }}" || echo "No changes to commit"
          git push

      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'âœ… Auto-fixes applied! Please review the changes in the PR.'
            });
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });
